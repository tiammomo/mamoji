# Mamoji 记账系统 - PRD 文档

## 项目概述

Mamoji 是一款简洁易用的个人记账系统，支持多账户管理、预算控制和收支分析。

## 产品愿景

提供简单直观的记账体验，帮助用户轻松管理个人财务，掌握消费习惯。

## 技术栈

| 层级 | 技术选型 |
|------|----------|
| 后端 | Java + Spring Boot 3.5.x + MyBatis-Plus |
| 构建工具 | Maven |
| 数据库 | MySQL 8.0 |
| 缓存 | Redis 7.x + Redisson (分布式缓存)<br>Caffeine (本地缓存) |
| 前端 | Next.js 16 + TypeScript |
| UI 组件 | shadcn/ui + Tailwind CSS |
| 认证 | JWT (Bearer Token) |
| 代码简化 | Lombok |

## 数据库设计

简化为 6 张核心表：

| 表名 | 用途 |
|------|------|
| sys_user | 用户账户 |
| sys_preference | 用户偏好 |
| fin_category | 收支分类 |
| fin_account | 账户 |
| fin_transaction | 交易记录 |
| fin_budget | 预算 |

## Redis 缓存设计

Redis 用于以下场景：

| 场景 | 用途 | 数据结构 | 过期时间 |
|------|------|----------|----------|
| Token 黑名单 | 登出后 Token 失效 | String | Token 剩余有效期 |
| 登录失败计数 | 防止暴力破解 | String (incr) | 15 分钟 |
| 账户锁定状态 | 锁定被攻击账户 | String | 15 分钟 |
| 验证码缓存 | 短信/邮箱验证码 | String | 5 分钟 |
| 热点数据缓存 | 用户分类列表、账户汇总 | Hash/String | 30 分钟 |

**Redis Key 规范：**

| Key Pattern | 说明 | 示例 |
|--------------|------|------|
| `mamoji:token:blacklist:{token}` | Token 黑名单 | `mamoji:token:blacklist:eyJhbG...` |
| `mamoji:login:fail:{username}` | 登录失败次数 | `mamoji:login:fail:test` |
| `mamoji:account:locked:{username}` | 账户锁定状态 | `mamoji:account:locked:test` |
| `mamoji:captcha:{type}:{target}` | 验证码 | `mamoji:captcha:phone:13800138000` |
| `mamoji:cache:category:{userId}` | 用户分类缓存 | `mamoji:cache:category:1` |
| `mamoji:cache:account:summary:{userId}` | 账户汇总缓存 | `mamoji:cache:account:summary:1` |

## 目标用户

- 个人用户：管理个人收支
- 记账爱好者：详细的财务分析

## 功能需求

### 1. 用户系统

| 功能 | 优先级 | 用户需求 | 详细规则 |
|------|--------|----------|----------|
| 用户注册 | P0 | 作为新用户，我希望通过用户名和密码注册账号，以便使用系统 | 1. 用户名 6-15 字符，支持英文、数字、下划线<br>2. 密码 6-20 字符<br>3. 支持手机号、邮箱（可选）<br>4. 注册成功后自动登录 |
| 用户登录 | P0 | 作为已注册用户，我希望通过用户名和密码登录，以便访问我的数据 | 1. 登录成功后返回 JWT Token<br>2. Token 有效期 24 小时<br>3. 连续登录失败 5 次锁定 15 分钟（Redis 计数）<br>4. 账户锁定期间禁止登录 |
| 用户登出 | P0 | 作为已登录用户，我希望退出登录，以便保护账户安全 | 1. 清除本地 Token<br>2. 后端将 Token 加入黑名单（Redis）<br>3. 清除登录失败计数 |
| Token 刷新 | P0 | 作为已登录用户，我希望 Token 自动续期，以便持续使用系统而无需重新登录 | 1. Token 剩余有效期 < 4 小时可刷新<br>2. 刷新后返回新 Token |
| 获取用户信息 | P0 | 作为已登录用户，我希望查看我的个人信息 | 1. 返回用户 ID、用户名、手机号、邮箱、角色、状态、创建时间 |
| 更新用户信息 | P1 | 作为已登录用户，我希望修改我的手机号和邮箱 | 1. 支持修改 phone、email<br>2. 邮箱格式校验 |
| 修改密码 | P1 | 作为已登录用户，我希望修改密码，以便保护账户安全 | 1. 需提供原密码<br>2. 新密码 6-20 字符<br>3. 修改后 Token 失效，需重新登录<br>4. 将旧 Token 加入黑名单 |

### 2. 账户管理

| 功能 | 优先级 | 用户需求 | 详细规则 |
|------|--------|----------|----------|
| 账户列表 | P0 | 作为用户，我希望查看所有账户的概览 | 1. 显示账户名称、类型、余额<br>2. 支持按状态筛选（正常/禁用）<br>3. 余额按类型分组汇总 |
| 添加账户 | P0 | 作为用户，我希望添加新账户，以便开始记账 | 1. 支持类型：bank_primary/bank_secondary/credit_card/cash/alipay/wechat/gold/fund_accumulation/fund/stock/topup/debt<br>2. 初始余额默认为 0<br>3. 默认计入总资产（除 credit_card/debt） |
| 账户详情 | P0 | 作为用户，我希望查看单个账户的详细信息 | 1. 显示账户完整信息<br>2. 显示最近 10 笔交易流水 |
| 编辑账户 | P1 | 作为用户，我希望修改账户信息 | 1. 支持修改 name、balance、includeInTotal、status<br>2. 余额变更需记录变更日志 |
| 删除账户 | P1 | 作为用户，我希望删除不再使用的账户 | 1. 软删除（status = 0）<br>2. 账户下有交易不允许删除 |
| 账户汇总 | P1 | 作为用户，我希望快速了解我的资产状况 | 1. 显示总余额、资金总额、信用总额、负债总额<br>2. 显示账户数量统计 |

**账户类型 (account_type) 说明：**

| account_type | account_sub_type | 说明 |
|--------------|------------------|------|
| bank | bank_primary | 一类银行卡 |
| bank | bank_secondary | 二类银行卡 |
| credit | credit_card | 信用卡 |
| cash | - | 现金 |
| alipay | - | 支付宝 |
| wechat | - | 微信 |
| gold | - | 黄金 |
| fund_accumulation | - | 公积金 |
| fund | - | 基金 |
| stock | - | 股票 |
| topup | - | 充值卡 |
| debt | - | 借款 |

**余额规则：**
- 资产类（bank/credit/cash/alipay/wechat/gold/fund_accumulation/fund/stock/topup）：余额为正数
- 负债类（credit/debt）：余额为负数

**计入总资产：**
- 默认计入（include_in_total = 1），可手动关闭

### 3. 交易记录

| 功能 | 优先级 | 用户需求 | 详细规则 |
|------|--------|----------|----------|
| 记收入 | P0 | 作为用户，我希望快速记录一笔收入 | 1. 选择账户（余额增加）<br>2. 选择分类（收入类，必选）<br>3. 输入金额<br>4. 选择发生时间（默认当前时间）<br>5. 可选填写备注 |
| 记支出 | P0 | 作为用户，我希望快速记录一笔支出 | 1. 选择账户（余额减少）<br>2. 选择分类（支出类，必选）<br>3. 输入金额<br>4. 选择发生时间（默认当前时间）<br>5. 可选填写备注 |
| 交易列表 | P0 | 作为用户，我希望查看我的所有交易记录 | 1. 支持按 type（收入/支出）筛选<br>2. 支持按分类筛选<br>3. 支持按账户筛选<br>4. 支持按日期范围筛选<br>5. 分页显示，每页 20 条<br>6. 按发生时间倒序排列 |
| 交易详情 | P0 | 作为用户，我希望查看单笔交易的详细信息 | 1. 显示交易类型、金额、分类、账户<br>2. 显示发生时间、备注<br>3. 显示创建时间、更新时间 |
| 编辑交易 | P1 | 作为用户，我希望修改错误的交易记录 | 1. 支持修改金额、分类、账户、发生时间、备注<br>2. 账户变更需同步调整原账户和新账户的余额 |
| 删除交易 | P1 | 作为用户，我希望删除错误的交易记录 | 1. 软删除（status = 0）<br>2. 删除后恢复对应账户余额 |

**记账流程规则：**

```
收入：选择账户 → 选择收入分类 → 输入金额 → 账户余额 +金额
支出：选择账户 → 选择支出分类 → 输入金额 → 账户余额 -金额
```

### 4. 分类管理

| 功能 | 优先级 | 用户需求 | 详细规则 |
|------|--------|----------|----------|
| 分类列表 | P0 | 作为用户，我希望查看所有可用的收支分类 | 1. 按类型分组（收入/支出）<br>2. 显示系统默认分类和用户自定义分类<br>3. user_id = 0 为系统分类 |
| 添加分类 | P1 | 作为用户，我希望创建自定义分类 | 1. 输入分类名称<br>2. 选择类型（收入/支出）<br>3. 同一用户下分类名称唯一 |
| 编辑分类 | P2 | 作为用户，我希望修改自定义分类的名称 | 1. 系统分类不可修改<br>2. 仅能修改自定义分类的 name 和 status |
| 删除分类 | P2 | 作为用户，我希望删除不再需要的自定义分类 | 1. 系统分类不可删除<br>2. 自定义分类下有交易不允许删除 |

**系统预置分类：**

| 收入分类 | 说明 |
|----------|------|
| 工资 | 薪资收入 |
| 奖金 | 奖金收入 |
| 投资收入 | 理财收益 |
| 其他收入 | 其他收入 |

| 支出分类 | 说明 |
|----------|------|
| 餐饮 | 日常餐饮 |
| 交通 | 出行费用 |
| 购物 | 日常购物 |
| 居住 | 房租/房贷/水电 |
| 娱乐 | 休闲娱乐 |
| 医疗 | 医疗健康 |
| 教育 | 学习培训 |
| 其他支出 | 其他支出 |

### 5. 预算管理

| 功能 | 优先级 | 用户需求 | 详细规则 |
|------|--------|----------|----------|
| 创建预算 | P0 | 作为用户，我希望创建预算 | 1. 输入预算名称<br>2. 输入预算金额<br>3. 选择开始日期和结束日期<br>4. 预算金额用于控制支出 |
| 预算列表 | P0 | 作为用户，我希望查看所有预算 | 1. 显示预算名称、金额、已花费、进度百分比<br>2. 显示时间段和状态<br>3. 按状态筛选（进行中/已完成/已取消） |
| 预算详情 | P0 | 作为用户，我希望查看预算的详细信息和使用进度 | 1. 显示预算基本信息<br>2. 显示已花费金额和剩余金额<br>3. 显示使用进度百分比<br>4. 显示关联交易数量 |
| 编辑预算 | P1 | 作为用户，我希望修改预算的金额或周期 | 1. 支持修改 name、amount、startDate、endDate、status<br>2. status 变更：进行中→已完成 |
| 删除预算 | P1 | 作为用户，我希望删除不再需要的预算 | 1. 删除预算不影响已记录的交易 |
| 预算执行报表 | P2 | 作为用户，我希望查看预算的执行情况分析 | 1. 显示所有预算的使用情况<br>2. 显示总预算、总花费、平均使用率 |

**预算状态：**

| 状态 | 说明 | 触发条件 |
|------|------|----------|
| 0 | 已取消 | 用户手动取消 |
| 1 | 进行中 | 正常进行中 |
| 2 | 已完成 | 正常结束 |
| 3 | 超支 | 已花费 > 预算金额 |

**预算计算规则：**

```
进度百分比 = 已花费 / 预算金额 × 100%
剩余金额 = 预算金额 - 已花费金额
当已花费 > 预算金额时，状态自动变为超支
```

### 6. 报表统计

| 功能 | 优先级 | 用户需求 | 详细规则 |
|------|--------|----------|----------|
| 收支概览 | P0 | 作为用户，我希望快速了解当前月的收支状况 | 1. 显示本月总收入、总支出、结余<br>2. 显示账户数量、交易数量<br>3. 支持按日期范围筛选 |
| 分类报表 | P0 | 作为用户，我希望了解各类别的收支占比 | 1. 按分类统计收入/支出金额<br>2. 计算各类别占比<br>3. 显示各类别交易笔数<br>4. 支持按日期范围筛选 |
| 月度报表 | P1 | 作为用户，我希望查看每日的收支趋势 | 1. 按天汇总每日收入、支出<br>2. 计算日均收入、日均支出<br>3. 显示单日最大支出<br>4. 传入年份和月份参数 |
| 趋势报表 | P1 | 作为用户，我希望按不同维度查看收支趋势 | 1. 支持按日/周/月分组<br>2. 显示趋势数据<br>3. 显示汇总统计（总收入、总支出、最大单日收支） |
| 资产负债表 | P2 | 作为用户，我希望了解我的资产和负债状况 | 1. 按资产类别分组显示资产<br>2. 按负债类别分组显示负债<br>3. 计算总资产、总负债、净资产 |

**报表筛选规则：**

- 默认筛选本月数据
- 支持自定义开始日期和结束日期
- 日期格式：YYYY-MM-DD

## 非功能需求

### 性能需求

- 页面加载时间 < 3秒
- API 响应时间 < 500ms
- 支持 10万+ 交易记录
- 单表查询响应时间 < 100ms

### 安全需求

- 密码 BCrypt 加密存储（cost factor = 10）
- JWT Token 认证（HS256 算法）
- HTTPS 传输加密
- 防止 SQL 注入（参数化查询）
- XSS 防护（输入过滤）
- CSRF 防护（Token 验证）

### 兼容性

- Web：Chrome、Firefox、Safari、Edge 最新版本
- 响应式适配：支持 375px - 1920px 屏幕宽度

## 验收标准

1. 用户可以完成注册、登录流程
2. 可以正常添加账户、记录收支
3. 预算功能正常使用
4. 报表数据准确（与交易记录一致）
5. 界面响应式适配
6. 无严重安全漏洞

## 排期规划

| 阶段 | 内容 | 周期 |
|------|------|------|
| Phase 1 | 用户系统、账户管理 | 2周 |
| Phase 2 | 交易记录、分类管理 | 2周 |
| Phase 3 | 预算管理、报表统计 | 2周 |
| Phase 4 | 系统设置、优化 | 1周 |

## 用户角色

| 角色 | 权限说明 |
|------|----------|
| normal | 普通用户，仅能查看和管理自己的数据 |
| admin | 管理员，预留用户管理功能 |
| super_admin | 超级管理员，预留系统管理功能 |

> 当前版本所有用户均为 normal 角色，多用户管理功能待后续扩展。

## 风险管理

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 技术选型变更 | 高 | 采用主流技术栈，降低学习成本 |
| 需求变更 | 中 | 敏捷开发，快速迭代 |
| 安全漏洞 | 高 | 定期安全审计，依赖漏洞扫描 |
| 数据丢失 | 中 | 定期备份，逻辑删除（软删除） |
