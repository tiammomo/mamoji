# 企业级财务记账系统 - 微服务架构设计

> **说明**: 本文档为微服务架构演进方案，保留了完整的微服务设计。
> 当前项目实际采用单体架构，详见 [主架构文档](../ARCHITECTURE.md)

## 一、技术架构

### 1.1 技术栈总览

| 层级 | 技术选型 | 版本要求 | 说明 |
|------|----------|----------|------|
| **前端框架** | Next.js | 14+ | App Router 模式 |
| **前端语言** | TypeScript | 5.0+ | 类型安全 |
| **UI组件库** | shadcn/ui | 最新 | 基于Radix UI |
| **状态管理** | Zustand | 4.x | 轻量级状态管理 |
| **图表库** | ECharts / Recharts | 最新 | 数据可视化 |
| **HTTP客户端** | Axios / Fetch | 最新 | 网络请求 |
| **后端框架** | Hertz | 0.8+ | CloudWeGo HTTP框架 |
| **后端语言** | Go | 1.25.5 | 高性能后端 |
| **ORM框架** | GORM | 2.x | 数据库操作 |
| **服务注册** | RocketMQ Namesrv | 5.x | 服务注册与发现 |
| **配置中心** | Nacos | 2.x | 配置管理 |
| **数据库** | MySQL | 8.0+ | 主关系型数据库 |
| **缓存** | Redis Cluster | 7.0+ | 分布式缓存 |
| **消息队列** | Apache RocketMQ | 5.x | 异步消息、事件驱动 |
| **部署容器** | Docker | 24+ | 容器化 |
| **编排工具** | Kubernetes | 1.28+ | 生产环境编排 |
| **反向代理** | Nginx | 1.24+ | 入口网关 |

### 1.2 微服务架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    客户端层                                           │
│  ┌─────────────────────────┐                      ┌─────────────────────────┐       │
 Web 前端           │                      │    │  │      移动端 H5           │       │
│  │   (Next.js + React)     │                      │   (Next.js + React)     │       │
│  │  ┌───────────────────┐  │                      │  ┌───────────────────┐  │       │
│  │  │ 状态管理 (Zustand) │  │                      │  │ 状态管理 (Zustand) │  │       │
│  │  │  API 客户端       │  │                      │  │  API 客户端       │  │       │
│  │  │  WebSocket 连接   │  │                      │  │  WebSocket 连接   │  │       │
│  │  └───────────────────┘  │                      │  └───────────────────┘  │       │
│  └─────────────────────────┘                      └─────────────────────────┘       │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           │ HTTPS / WebSocket
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                 流量入口层                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                           Kubernetes Ingress / Nginx                          │    │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │    │
│  │  │ SSL终结     │  │ 负载均衡    │  │ 静态资源    │  │ 限流熔断    │          │    │
│  │  │ HTTPS       │  │ L4/L7       │  │ gzip压缩    │  │ Rate Limit  │          │    │
│  │  │ 证书管理    │  │ 会话保持    │  │ 缓存        │  │ Circuit Brk │          │    │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘          │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   API 网关层                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │                      Hertz API Gateway (Kong 替代方案)                        │    │
│  │                                                                           │    │
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌───────────────┐   │    │
│  │  │   路由转发     │ │    认证鉴权    │ │    限流熔断    │ │    日志追踪    │   │    │
│  │  │   Route       │ │   Auth        │ │   Rate Limit  │ │   Trace       │   │    │
│  │  └───────────────┘ └───────────────┘ └───────────────┘ └───────────────┘   │    │
│  │                                                                           │    │
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐                    │    │
│  │  │   协议转换     │ │    负载均衡    │ │   服务发现    │                    │    │
│  │  │   Protocol    │ │   Load Balance│ │   Discovery   │                    │    │
│  │  └───────────────┘ └───────────────┘ └───────────────┘                    │    │
│  │                                                                           │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                                           │ 服务发现
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   微服务层                                            │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                            业务微服务群                                       │   │
│  │                                                                          │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │   │
│  │  │ user-svc │ │ ent-svc  │ │ acc-svc  │ │ tx-svc   │ │ budget-svc│       │   │
│  │  │ :9001    │ │ :9002    │ │ :9003    │ │ :9004    │ │ :9005    │       │   │
│  │  │ 用户服务  │ │ 企业服务  │ │ 账户服务  │ │ 账单服务  │ │ 预算服务  │       │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘       │   │
│  │                                                                          │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │   │
│  │  │ inv-svc  │ │ ast-svc  │ │ rpt-svc  │ │ not-svc  │ │ push-svc │       │   │
│  │  │ :9006    │ │ :9007    │ │ :9010    │ │ :9020    │ │ :9030    │       │   │
│  │  │ 投资服务  │ │ 资产服务  │ │ 报表服务  │ │ 通知服务  │ │ 推送服务  │       │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘       │   │
│  │                                                                          │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐                                │   │
│  │  │ upl-svc  │ │ sch-svc  │ │ com-svc  │                                │   │
│  │  │ :9040    │ │ :9050    │ │ :9090    │                                │   │
│  │  │ 上传服务  │ │ 调度服务  │ │ 公共服务  │                                │   │
│  │  └──────────┘ └──────────┘ └──────────┘                                │   │
│  │                                                                          │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                         Hertz 服务内部架构                                    │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐           │   │   │
│  │  │  │ Handler   │ │ Service   │ │ Repository│ │  Model    │           │   │   │
│  │  │  │ 路由处理  │ │ 业务逻辑  │ │ 数据访问  │ │ 数据模型  │           │   │   │
│  │  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘           │   │   │
│  │  └─────────────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                           │
                    ┌──────────────────────┼──────────────────────┐
                    ▼                      ▼                      ▼
┌───────────────────────────┐ ┌───────────────────────────┐ ┌───────────────────────────┐
│        数据层              │ │        缓存层              │ │        消息层              │
│  ┌─────────────────────┐  │ │  ┌─────────────────────┐  │ │  ┌─────────────────────┐  │
│  │    MySQL Cluster    │  │ │  │    Redis Cluster    │  │ │  │   RocketMQ Cluster   │  │
│  │  ┌─────────────────┐│  │ │  │  ┌─────────────────┐│  │ │  │  ┌─────────────────┐│  │
│  │  │  sys 库 (用户)  ││  │ │  │  │  会话缓存       ││  │ │  │  │  NameSrv 集群   ││  │
│  │  │  biz 库 (业务)  ││  │ │  │  │  数据缓存       ││  │ │  │  │  Broker 集群   ││  │
│  │  │  ───────────────││  │ │  │  │  分布式锁       ││  │ │  │  │  Console       ││  │
│  │  │  主从复制       ││  │ │  │  │  限流计数器     ││  │ │  │  └─────────────────┘│  │
│  │  │  分库分表       ││  │ │  │  │  ───────────────││  │ │  │                     │  │
│  │  └─────────────────┘│  │ │  │  │  Redis Sentinel││  │ │  │  ┌─────────────────┐│  │
│  │                     │  │ │  └─────────────────┘│  │ │  │  │  Topic 消息主题  ││  │
│  └─────────────────────┘  │ │                     │  │ │  │  └─────────────────┘│  │
│                           │ └─────────────────────┘  │ └─────────────────────┘  │
└───────────────────────────┘ └───────────────────────────┘ └───────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                 基础设施层                                           │
│  ┌───────────────────────────┐ ┌───────────────────────────┐ ┌─────────────────────┐ │
│  │     Nacos 配置中心        │ │    监控告警中心           │ │   日志系统          │ │
│  │  ┌─────────────────────┐  │ │  ┌─────────────────────┐  │ │  ┌───────────────┐  │ │
│  │  │  配置管理           │  │ │  │  Prometheus         │  │ │  │   ELK Stack   │  │ │
│  │  │  配置变更推送       │  │ │  │  Grafana            │  │ │  │  Logstash     │  │ │
│  │  │  命名服务           │  │ │  │  AlertManager       │  │ │  │  Kibana       │  │ │
│  │  │  集群管理           │  │ │  │  Jaeger             │  │ │  │               │  │ │
│  │  └─────────────────────┘  │ │  └─────────────────────┘  │ │  └───────────────┘  │ │
│  └───────────────────────────┘ └───────────────────────────┘ └─────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、微服务清单

### 2.1 服务总览

| 服务名 | 端口 | 职责 | 数据库 | API前缀 |
|--------|------|------|--------|---------|
| **api-gateway** | 8080 | 请求路由、认证鉴权、限流熔断 | - | /api/v1/* |
| **user-service** | 9001 | 用户注册登录、企业成员管理 | sys_* | /api/v1/auth/*, /api/v1/users/* |
| **enterprise-service** | 9002 | 企业信息、记账单元管理 | biz_enterprise_* | /api/v1/enterprise/*, /api/v1/accounting-units/* |
| **account-service** | 9003 | 账户管理、流水记录 | biz_account_* | /api/v1/accounts/* |
| **transaction-service** | 9004 | 账单记录、分类管理 | biz_transaction_* | /api/v1/transactions/* |
| **budget-service** | 9005 | 预算管理、审批流程 | biz_budget_* | /api/v1/budgets/* |
| **investment-service** | 9006 | 投资理财、市值追踪 | biz_investment_* | /api/v1/investments/* |
| **asset-service** | 9007 | 固定资产、无形资产、折旧 | biz_asset_* | /api/v1/assets/* |
| **report-service** | 9010 | 报表统计、数据分析 | - | /api/v1/statistics/* |
| **notification-service** | 9020 | 消息通知、站内消息 | biz_notification_* | /api/v1/notifications/* |
| **push-service** | 9030 | 邮件/短信/微信推送 | biz_push_* | /api/v1/push-* |
| **upload-service** | 9040 | 文件上传、图片处理 | - | /api/v1/upload/* |
| **scheduler-service** | 9050 | 定时任务调度 | - | - |
| **common-service** | 9090 | 公共服务(字典、配置) | sys_* | /api/v1/dict/* |

### 2.2 服务依赖关系

```
                              ┌─────────────────┐
                              │  api-gateway    │
                              │     (8080)      │
                              └────────┬────────┘
                                       │
        ┌──────────────┬───────────────┼───────────────┬──────────────┐
        ▼              ▼               ▼               ▼              ▼
   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
   │ user-svc │ │ ent-svc  │ │ acc-svc  │ │ tx-svc   │ │ budget-svc│
   │ (9001)   │ │ (9002)   │ │ (9003)   │ │ (9004)   │ │ (9005)   │
   └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘
        │             │            │            │            │
        │             │            │            │            │
        └─────────────┼────────────┼────────────┼────────────┘
                      │            │            │
                      ▼            ▼            ▼
               ┌─────────────────────────────────────────────┐
               │              RocketMQ (消息总线)              │
               └─────────────────────────────────────────────┘
                      │            │            │
                      ▼            ▼            ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
        │ not-svc  │ │ rpt-svc  │ │ push-svc │ │ ast-svc  │
        │ (9020)   │ │ (9010)   │ │ (9030)   │ │ (9007)   │
        └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘
             │             │            │            │
             │             │            │            │
             └─────────────┼────────────┼────────────┘
                           │            │
                           ▼            ▼
                  ┌─────────────────────────────┐
                  │    scheduler-service (9050)  │
                  │    (定时任务触发)            │
                  └─────────────────────────────┘
                           │
                           ▼
                  ┌─────────────────────────────┐
                  │    common-service (9090)    │
                  │    (公共服务依赖)            │
                  └─────────────────────────────┘
```

---

## 三、核心模块设计

### 3.1 服务通信

#### 3.1.1 同步通信 (HTTP/gRPC)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         同步通信流程                                      │
│                                                                         │
│  客户端 ──▶ API Gateway ──▶ Service A ──▶ Service B                    │
│                            │                   │                         │
│                            ▼                   ▼                         │
│                       HTTP/gRPC           HTTP/gRPC                     │
│                                                                         │
│  适用场景:                                                               │
│  - 需要即时响应的请求                                                    │
│  - 简单的请求-响应模式                                                   │
│                                                                         │
│  示例:                                                                  │
│  1. 用户登录 → user-service 返回用户信息 + Token                        │
│  2. 创建账单 → tx-service 验证账户余额 (调用 account-service)           │
│  3. 预算审批 → budget-service 获取申请人信息 (调用 user-service)        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.1.2 异步通信 (RocketMQ)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         异步通信流程                                      │
│                                                                         │
│  Service A ──▶ Topic ──▶ Consumer Group ──▶ Service B                  │
│                            │                                            │
│                            ▼                                            │
│                       消息持久化                                         │
│                       顺序消费 / 广播                                   │
│                                                                         │
│  适用场景:                                                               │
│  - 耗时操作、异步处理                                                    │
│  - 跨服务事务、最终一致性                                               │
│  - 事件驱动、解耦                                                       │
│                                                                         │
│  示例:                                                                  │
│  1. 账单创建 ──▶ 更新账户流水 (最终一致性)                              │
│  2. 预算超支 ──▶ 发送预警通知                                            │
│  3. 每日定时 ──▶ 生成资产报告                                            │
│  4. 投资更新 ──▶ 推送收益提醒                                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 RocketMQ 主题设计

#### 3.2.1 Topic 规划

| Topic | 消息类型 | 描述 | 生产者 | 消费者 |
|-------|----------|------|--------|--------|
| **TX_CREATE** | 事务消息 | 账单创建事件 | transaction-service | account-service, notification-service |
| **TX_UPDATE** | 普通消息 | 账单更新事件 | transaction-service | account-service |
| **BUDGET_ALERT** | 普通消息 | 预算预警通知 | budget-service | notification-service, push-service |
| **INVEST_UPDATE** | 普通消息 | 投资市值更新 | investment-service | notification-service |
| **INVEST_REMINDER** | 定时消息 | 投资提醒检查 | scheduler-service | notification-service |
| **REPORT_DAILY** | 普通消息 | 每日报告生成 | scheduler-service | report-service, push-service |
| **ASSET_DEPRECIATION** | 普通消息 | 资产折旧处理 | scheduler-service | asset-service |
| **NOTIFICATION_SEND** | 普通消息 | 通知发送 | notification-service | push-service |
| **USER_ACTION** | 事务消息 | 用户行为日志 | all services | analytics-service |

#### 3.2.2 消息格式

```json
{
    "messageId": "msg_xxx_xxx",
    "topic": "TX_CREATE",
    "tags": "transaction_created",
    "timestamp": 1703894400000,
    "body": {
        "transactionId": "tx_123",
        "enterpriseId": "ent_456",
        "unitId": "unit_789",
        "type": "income",
        "amount": 1000.00,
        "accountId": "acc_001",
        "createdBy": "user_001",
        "createdAt": "2024-01-01T00:00:00Z"
    },
    "header": {
        "traceId": "trace_xxx",
        "spanId": "span_xxx",
        "sourceService": "transaction-service",
        "version": "1.0"
    }
}
```

### 3.3 分布式事务

```
┌─────────────────────────────────────────────────────────────────────────┐
│                   基于 RocketMQ 的分布式事务方案                          │
│                                                                         │
│  Service A (账单创建)                 Service B (账户更新)              │
│        │                                    │                            │
│        │  1. 执行本地事务                    │                            │
│        │  2. 发送 Prepare 消息               │                            │
│        │  ─────────────────────────────────▶│                            │
│        │                                    │                            │
│        │                                    │  3. 消费 Prepare 消息      │
│        │                                    │  4. 执行本地事务           │
│        │                                    │  5. 发送 Commit/Rollback   │
│        │                                    │                            │
│        │  6. 收到 Commit                    │                            │
│        │  7. 发送成功通知                    │                            │
│        │                                    │                            │
│  ──────────────────────────────────────────────────────────────        │
│                                                                         │
│  事务消息状态:                                                          │
│  - UNKNOWN: 中间状态, 需要回查                                          │
│  - COMMIT: 提交, 消费者可以处理                                         │
│  - ROLLBACK: 回滚, 消费者不处理                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.4 服务注册与发现

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         服务注册与发现                                    │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     服务注册中心 (RocketMQ Namesrv)              │   │
│  │                                                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │   │
│  │  │ user-service │  │ tx-service  │  │ not-service │              │   │
│  │  │  :9001      │  │  :9004      │  │  :9020      │              │   │
│  │  │  192.168.1.1│  │  192.168.1.2│  │  192.168.1.3│              │   │
│  │  │  healthy ✓  │  │  healthy ✓  │  │  healthy ✓  │              │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘              │   │
│  │                                                                 │   │
│  │  心跳机制: 每30秒续约, 超时90秒自动剔除                          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                │                                          │
│                                ▼                                          │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     负载均衡策略                                 │   │
│  │                                                                 │   │
│  │  - 轮询 (Round Robin)                                           │   │
│  │  - 加权轮询 (Weighted Round Robin)                              │   │
│  │  - 最少连接 (Least Connection)                                   │   │
│  │  - 一致性哈希 (Consistent Hash)                                  │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.5 配置中心 (Nacos)

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           配置管理                                       │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Nacos 配置中心                               │   │
│  │                                                                 │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  应用配置                                                 │   │   │
│  │  │  ├── user-service.yaml                                   │   │   │
│  │  │  ├── transaction-service.yaml                            │   │   │
│  │  │  ├── notification-service.yaml                           │   │   │
│  │  │  └── api-gateway.yaml                                    │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │                                                                 │   │
│  │  ┌─────────────────────────────────────────────────────────┐   │   │
│  │  │  公共配置                                                 │   │   │
│  │  │  ├── database.yaml (数据库配置)                          │   │   │
│  │  │  ├── redis.yaml (Redis配置)                              │   │   │
│  │  │  └── rocketmq.yaml (RocketMQ配置)                        │   │   │
│  │  └─────────────────────────────────────────────────────────┘   │   │
│  │                                                                 │   │
│  │  配置更新: 实时推送 + 热更新                                    │   │
│  │  版本管理: 配置变更历史追溯                                     │   │
│  │  权限控制: 命名空间隔离                                         │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 四、数据模型设计

### 4.1 数据库分片策略

| 库名 | 表前缀 | 分片键 | 分片策略 |
|------|--------|--------|----------|
| **sys_** | sys_* | - | 公共库, 按用户ID分表 |
| **biz_enterprise** | biz_enterprise_* | enterprise_id | 按企业ID取模 |
| **biz_account** | biz_account_* | enterprise_id | 按企业ID取模 |
| **biz_transaction** | biz_transaction_* | enterprise_id | 按企业ID取模 |
| **biz_budget** | biz_budget_* | enterprise_id | 按企业ID取模 |
| **biz_investment** | biz_investment_* | enterprise_id | 按企业ID取模 |
| **biz_asset** | biz_asset_* | enterprise_id | 按企业ID取模 |
| **biz_notification** | biz_notification_* | user_id | 按用户ID取模 |
| **biz_push** | biz_push_* | enterprise_id | 按企业ID取模 |

### 4.2 数据一致性

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         数据一致性策略                                    │
│                                                                         │
│  1. 强一致性 (事务)                                                     │
│     - 单服务内操作: 本地事务                                             │
│     - 跨服务操作: RocketMQ 事务消息                                     │
│                                                                         │
│  2. 最终一致性                                                          │
│     - 异步消息: 账单创建 → 账户流水                                      │
│     - 定时对账: 每日检查数据一致性                                       │
│                                                                         │
│  3. 补偿机制                                                            │
│     - 事务回滚: 发送 Rollback 消息                                      │
│     - 幂等处理: 消息去重 + 状态检查                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 五、安全设计

### 5.1 认证授权

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         认证授权流程                                      │
│                                                                         │
│  JWT Token 认证流程:                                                    │
│                                                                         │
│  1. 用户登录 ──▶ user-service ──▶ 生成 JWT Token                        │
│                                                                      │   │
│  2. 客户端请求 ──▶ API Gateway ──▶ 验证 Token                          │
│                                           │                             │
│                                           ▼                             │
│                                    解析 Token 获取用户信息               │
│                                           │                             │
│                                           ▼                             │
│                                    检查用户权限                          │
│                                           │                             │
│                    ┌───────────────────────┼───────────────────────┐    │
│                    ▼                       ▼                       ▼    │
│              放行请求                 返回403                  返回401   │
│                                                                         │
│  权限控制:                                                              │
│  - 企业级角色: 超级管理员、财务管理员、普通成员、只读成员               │
│  - 单元级权限: 查看、编辑、管理 (按记账单元配置)                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 安全措施

| 层级 | 措施 | 说明 |
|------|------|------|
| 传输层 | HTTPS | SSL/TLS 加密传输 |
| 认证层 | JWT | Token 认证, 有效期24小时 |
| 网关层 | API Gateway | 限流、防刷 |
| 服务层 | 权限控制 | RBAC + 单元权限 |
| 数据层 | 数据脱敏 | 手机号、身份证脱敏 |
| 审计层 | 操作日志 | 记录所有敏感操作 |

---

## 六、缓存策略

### 6.1 多级缓存架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           多级缓存设计                                    │
│                                                                         │
│  L1: 本地缓存 (Caffeine)                                                │
│      - 大小: 10000 条                                                   │
│      - TTL: 5分钟                                                       │
│      - 适用: 热点数据、高频访问                                         │
│                                                                         │
│  L2: Redis 分布式缓存                                                   │
│      ┌──────────────────────────────────────────────────────────────┐  │
│      │ 缓存类型              │ Key前缀           │ TTL              │  │
│      ├──────────────────────────────────────────────────────────────┤  │
│      │ 用户信息              │ user:info:       │ 30分钟          │  │
│      │ 企业信息              │ ent:info:        │ 30分钟          │  │
│      │ 记账单元列表          │ unit:list:       │ 10分钟          │  │
│      │ 账户余额              │ acc:balance:     │ 5分钟           │  │
│      │ 账单列表              │ tx:list:         │ 5分钟           │  │
│      │ 统计数据              │ stat:            │ 10分钟          │  │
│      └──────────────────────────────────────────────────────────────┘  │
│                                                                         │
│  L3: 数据库 (兜底)                                                      │
│      - 缓存穿透: 布隆过滤器                                             │
│      - 缓存击穿: 互斥锁                                                │
│      - 缓存雪崩: 随机TTL + 持久化                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 七、监控告警

### 7.1 监控体系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         微服务监控体系                                    │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                      可观测性三大支柱                            │   │
│  │                                                                 │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │   │
│  │  │   链路追踪    │  │    指标监控   │  │    日志聚合   │          │   │
│  │  │  (Jaeger)    │  │  (Prometheus) │  │   (ELK)      │          │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  监控指标:                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  服务指标:                                                        │   │
│  │  - QPS、响应时间(P50/P95/P99)                                    │   │
│  │  - 错误率、成功率                                                │   │
│  │  - 并发数、超时率、重试次数                                      │   │
│  │                                                                 │   │
│  │  基础设施指标:                                                    │   │
│  │  - CPU、内存、磁盘、网络                                         │   │
│  │  - Pod 状态、容器健康                                            │   │
│  │                                                                 │   │
│  │  业务指标:                                                        │   │
│  │  - 日活、转化率、订单量                                          │   │
│  │  - 账单数、预算执行率                                            │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  告警规则:                                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │  - P99 响应时间 > 2s: 警告                                       │   │
│  │  - 错误率 > 1%: 警告                                             │   │
│  │  - 服务实例 < 最小数量: 严重                                     │   │
│  │  - CPU > 80%: 警告                                               │   │
│  │  - 磁盘 > 90%: 严重                                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.2 日志规范

```
日志格式:
{
    "timestamp": "2024-01-01T00:00:00.000Z",
    "level": "INFO",
    "traceId": "trace_xxx",
    "spanId": "span_xxx",
    "service": "user-service",
    "host": "192.168.1.1",
    "message": "用户登录成功",
    "data": {
        "userId": "user_001",
        "enterpriseId": "ent_001"
    }
}

日志级别:
- ERROR: 错误、异常
- WARN: 警告、潜在问题
- INFO: 关键业务操作
- DEBUG: 调试信息 (生产环境关闭)
```

---

## 八、部署架构

### 8.1 Kubernetes 部署

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              Kubernetes 集群架构                                      │
│                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              Namespace 划分                                   │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  mamoji-gateway  (网关层)                                            │   │   │
│  │  │  ├── api-gateway Deployment (3副本)                                  │   │   │
│  │  │  └── Ingress                                                        │   │   │
│  │  └─────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  mamoji-services  (业务层)                                           │   │   │
│  │  │  ├── user-service Deployment (2-10副本)                              │   │   │
│  │  │  ├── account-service Deployment (2-10副本)                           │   │   │
│  │  │  ├── transaction-service Deployment (3-15副本)                       │   │   │
│  │  │  ├── budget-service Deployment (2-5副本)                             │   │   │
│  │  │  ├── investment-service Deployment (2-5副本)                         │   │   │
│  │  │  ├── asset-service Deployment (2-5副本)                              │   │   │
│  │  │  ├── report-service Deployment (2-5副本)                             │   │   │
│  │  │  ├── notification-service Deployment (2-5副本)                       │   │   │
│  │  │  ├── push-service Deployment (2-5副本)                               │   │   │
│  │  │  ├── upload-service Deployment (2-5副本)                             │   │   │
│  │  │  ├── scheduler-service Deployment (1-3副本)                          │   │   │
│  │  │  └── common-service Deployment (2-5副本)                             │   │   │
│  │  └─────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  mamoji-infra  (基础设施)                                            │   │   │
│  │  │  ├── mysql StatefulSet (主从)                                        │   │   │
│  │  │  ├── redis StatefusSet (Cluster)                                     │   │   │
│  │  │  ├── rocketmq StatefulSet (NameSrv + Broker)                        │   │   │
│  │  │  └── nacos StatefulSet (高可用)                                      │   │   │
│  │  └─────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  mamoji-monitoring  (监控)                                           │   │   │
│  │  │  ├── prometheus Deployment                                           │   │   │
│  │  │  ├── grafana Deployment                                             │   │   │
│  │  │  ├── jaeger Deployment                                              │   │   │
│  │  │  └── elasticsearch Deployment (ELK)                                  │   │   │
│  │  └─────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                              │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 资源规划

| 服务 | CPU请求 | CPU限制 | 内存请求 | 内存限制 | 副本数 |
|------|---------|---------|----------|----------|--------|
| api-gateway | 500m | 2000m | 512Mi | 2Gi | 3 |
| user-service | 250m | 1000m | 256Mi | 1Gi | 2-10 |
| account-service | 250m | 1000m | 256Mi | 1Gi | 2-10 |
| transaction-service | 500m | 2000m | 512Mi | 2Gi | 3-15 |
| budget-service | 250m | 1000m | 256Mi | 1Gi | 2-5 |
| investment-service | 250m | 1000m | 256Mi | 1Gi | 2-5 |
| notification-service | 250m | 1000m | 256Mi | 1Gi | 2-5 |
| report-service | 500m | 2000m | 512Mi | 2Gi | 2-5 |

---

## 九、微服务拆分方案

### 9.1 演进路线图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      微服务演进路线图                                     │
│                                                                         │
│  Phase 1: 单体应用 (当前)                                               │
│  ┌─────────────────────────────────────────────────────────────┐       │
│  │  Mamoji 单体应用                                             │       │
│  │  - 所有模块在一个进程中                                      │       │
│  │  - 本地方法调用                                              │       │
│  │  - 共享数据库                                                │       │
│  └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
│  Phase 2: 垂直拆分 (6个月)                                              │
│  ┌───────────────────────┐ ┌───────────────────────┐                   │
│  │  用户服务              │ │  业务服务              │                   │
│  │  user-service         │ │  biz-service          │                   │
│  │  - 用户管理            │ │  - 账户/账单/预算      │                   │
│  │  - 企业管理            │ │  - 投资/资产/报表      │                   │
│  │  - 认证授权            │ │  - 通知/推送           │                   │
│  └───────────────────────┘ └───────────────────────┘                   │
│                    │                        │                           │
│                    └───────────┬────────────┘                           │
│                                ▼                                        │
│                    ┌───────────────────────┐                           │
│                    │  RocketMQ (事件驱动)   │                           │
│                    └───────────────────────┘                           │
│                                                                         │
│  Phase 3: 完整微服务 (12个月)                                           │
│  ┌─────────────────────────────────────────────────────────────┐       │
│  │  API Gateway + 13个微服务集群                               │       │
│  │  - 独立部署、独立扩展                                        │       │
│  │  - 独立数据库 (分库分表)                                     │       │
│  │  - 完整的注册发现、配置中心、链路追踪                        │       │
│  └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.2 拆分原则

1. **边界清晰**: 每个服务有独立的业务领域
2. **松耦合**: 服务间通过API/事件通信，不共享数据库
3. **高内聚**: 相关功能集中在同一服务
4. **可独立部署**: 服务可以独立开发、测试、部署
5. **团队自治**: 每个服务可由独立团队负责

### 9.3 服务划分

| 服务名 | 职责 | 团队 | 依赖 |
|--------|------|------|------|
| api-gateway | 请求路由、认证 | 平台组 | 所有服务 |
| user-service | 用户、企业、成员 | 用户组 | - |
| enterprise-service | 企业、单元 | 企业组 | user-service |
| account-service | 账户、流水 | 财务组 | enterprise-service |
| transaction-service | 账单、分类 | 财务组 | account-service |
| budget-service | 预算、审批 | 财务组 | user-service |
| investment-service | 投资、收益 | 财务组 | - |
| asset-service | 资产、折旧 | 财务组 | - |
| report-service | 报表、统计 | 数据组 | 所有业务服务 |
| notification-service | 消息、模板 | 通知组 | - |
| push-service | 邮件/短信/微信 | 通知组 | notification-service |
| upload-service | 文件上传 | 平台组 | - |
| scheduler-service | 定时任务 | 平台组 | 所有业务服务 |
| common-service | 字典、配置 | 平台组 | - |

---

## 十、开发规范

### 10.1 项目结构

```
mamoji/
├── api-gateway/              # API网关服务
│   ├── handler/              # 路由处理
│   ├── middleware/           # 中间件
│   ├── router/               # 路由定义
│   └── config/               # 配置
│
├── services/                 # 微服务目录
│   ├── user-service/
│   │   ├── handler/          # HTTP处理器
│   │   ├── service/          # 业务逻辑
│   │   ├── repository/       # 数据访问
│   │   ├── model/            # 数据模型
│   │   ├── client/           # 外部服务客户端
│   │   └── config/           # 配置
│   │
│   ├── transaction-service/
│   ├── account-service/
│   ├── budget-service/
│   └── ... (其他服务)
│
├── common/                   # 公共模块
│   ├── config/               # 通用配置
│   ├── middleware/           # 通用中间件
│   ├── client/               # 通用客户端
│   └── utils/                # 工具函数
│
├── deploy/                   # 部署配置
│   ├── k8s/                  # Kubernetes配置
│   └── docker/               # Docker配置
│
└── docs/                     # 文档
```

### 10.2 代码规范

- **命名规范**: 驼峰命名, 包名小写
- **错误处理**: 使用 error wrapping, 统一错误码
- **日志规范**: 结构化日志, 包含 traceId
- **测试要求**: 单元测试覆盖率 > 60%
- **代码评审**: PR 必须经过评审才能合并
